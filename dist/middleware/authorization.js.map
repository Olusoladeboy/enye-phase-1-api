{"version":3,"sources":["../../src/middleware/authorization.js"],"names":["dotenv","config","logger","log4js","getLogger","module","getToken","req","headers","authorization","split","query","token","checkAuth","res","next","JWT","jwtSecret","err","decoded","console","log","user","id","userType","email","phone","currentIp","method","body","createdBy","updatedBy","deleted","deletedAt","Date","now","deletedBy","message","isValidUser","error","path","isAuthorized","reqAction","role","roleName","name","permissionArray","permissions","resource","replace","toUpperCase","requiredPermission","permissionRecords","find","item","msg"],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable object-curly-newline */\n/* eslint-disable no-console */\n/* eslint-disable arrow-parens */\nimport dotenv from 'dotenv';\nimport { verify } from 'jsonwebtoken';\nimport { JWT } from '../constants';\nimport { fail, hasProp, safeGet, log4js, getRequestIp } from '../util';\n\ndotenv.config();\n\nconst logger = log4js.getLogger(`[${module}]`);\n\n// Retrieve token from request header\nexport function getToken(req) {\n  if (req.headers.authorization && req.headers.authorization.split(' ')[0] === 'Bearer') {\n    return req.headers.authorization.split(' ')[1];\n  }\n  if (req.query && hasProp(req.query, 'token')) {\n    return req.query.token;\n  }\n  return null;\n}\n\nexport function checkAuth(req, res, next) {\n  try {\n    const token = getToken(req);\n    if (!token) return fail(res, 403, 'No token found in request header!');\n    // eslint-disable-next-line complexity\n    return verify(token, JWT.jwtSecret, (err, decoded) => {\n      console.log(decoded);\n      if (err) return fail(res, 403, 'Failed to authenticate token.!');\n      req.user = {\n        id: decoded.id,\n        userType: decoded.userType,\n        email: decoded.email,\n        phone: decoded.phone,\n        currentIp: getRequestIp(req),\n\n      };\n      if (req.method === 'POST') {\n        req.body.createdBy = req.user.id;\n      } else if (req.method === 'PUT') {\n        req.body.updatedBy = req.user.id;\n      } else if (req.method === 'PATCH') {\n        if (req.body.deleted === true || req.body.deleted === 'true') {\n          req.body = {};\n          req.body.deleted = true;\n          req.body.deletedAt = Date.now();\n          req.body.deletedBy = req.user.id;\n        }\n      } else if (req.method === 'DELETE') {\n        req.body = {};\n      }\n      return next();\n    });\n  } catch (err) {\n    console.log('Error from check authorization');\n    return fail(res, 403, `user not Authenticated! ${err.message}`);\n  }\n}\n\nexport function isValidUser(req, res, next) {\n  try {\n    console.log('User ==> ', req.user);\n    const { userType, id, email, phone } = req.user;\n    if (userType !== 'User') return fail(res, 403, 'Invalid User credentials!');\n    console.log(`\\nValidating userType ${userType}, id ${id}, email ${email}, phone ${phone}`);\n    // if (email === 'admin@peacegroup.ng' || safeGet(role, 'name') === 'SUPER_ADMIN') return next();\n    // if (!role) return fail(res, 403, 'Invalid User credentials! No user-role found');\n    return next();\n    // return isAuthorized(req, res,next);\n  } catch (err) {\n    logger.error(`[400] [${getRequestIp(req)}] [${req.method}] [${safeGet(req.user, 'email')}] - [${req.path}], [Authentication], ${err.message}`);\n    return fail(res, 403, `User not Validated! ${err.message}`);\n  }\n}\n\nexport function isAuthorized(req, res, next) {\n  try {\n    let reqAction;\n    const { path, method } = req;\n    switch (method) {\n      case 'POST':\n        reqAction = 'CREATE';\n        break;\n      case 'PUT':\n        reqAction = 'UPDATE';\n        break;\n      case 'PATCH':\n        reqAction = 'HIDE';\n        break;\n      case 'DELETE':\n        reqAction = 'DELETE';\n        break;\n      case 'GET':\n        reqAction = 'READ';\n        break;\n      default:\n        reqAction = 'READ';\n        break;\n    }\n    const { name: roleName, permissions: permissionArray } = req.user.role;\n    if (roleName === 'SUPER_ADMIN') return next();\n    const resource = path.split('/', 2)[1].replace(/-/g, '').replace(/s$/, '').toUpperCase();\n    const requiredPermission = `${reqAction}_${resource}`;\n    if (!permissionArray) return fail(res, 403, 'Invalid User credentials! No permission found - 101');\n    const permissionRecords = permissionArray.find(item => item.name === requiredPermission);\n    const msg = `Invalid credentials! Role ${roleName} lacks permission ${requiredPermission}`;\n    if (!permissionRecords) return fail(res, 403, msg);\n    return next();\n  } catch (err) {\n    logger.error(`[400] [${getRequestIp(req)}] [${req.method}] [${safeGet(req.user, 'email')}] - [${req.path}], [Authentication], ${err.message}`);\n    return fail(res, 403, `User not Authorized! ${err.message}`);\n  }\n}\n"],"file":"authorization.js"}